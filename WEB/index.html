<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DondeMeLlega.es</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js"></script>

    <style>
        /* --- ESTILOS BASE --- */
        :root {
            --primary: #111827;
            --accent: #2563eb;
            --surface: rgba(255, 255, 255, 0.95);
            --shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.15);
        }

        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; overflow: hidden; background: #e5e7eb; }
        
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 0; }

        /* --- UI FLOTANTE --- */
        .ui-container {
            position: absolute;
            top: 24px; left: 24px;
            width: 360px;
            z-index: 1000;
            transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1); /* Animaci√≥n suave estilo iOS */
        }

        .card {
            background: var(--surface);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 24px;
            border-radius: 24px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.6);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* √Årea clickeable para colapsar (Header) */
        .card-header {
            cursor: pointer; /* Manita para indicar click */
        }

        /* La barrita decorativa (Handle) */
        .drag-handle {
            width: 40px; height: 5px;
            background: #e5e7eb;
            border-radius: 10px;
            margin: -10px auto 15px auto; /* Centrado arriba */
            display: none; /* Oculto en PC por defecto */
        }

        h2 { margin: 0; font-size: 1.25rem; font-weight: 800; color: var(--primary); letter-spacing: -0.03em; }
        .subtitle { font-size: 0.875rem; color: #6b7280; display: block; margin-top: 4px;}

        /* Inputs */
        .input-group label { display: block; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #9ca3af; margin-bottom: 6px; letter-spacing: 0.05em; }
        .input-wrapper { position: relative; display: flex; align-items: center; }
        input { width: 100%; padding: 12px 16px; border: 2px solid #f3f4f6; border-radius: 12px; font-size: 1rem; font-weight: 600; color: var(--primary); outline: none; transition: border 0.2s; font-family: 'Inter', sans-serif; }
        input:focus { border-color: var(--accent); }
        .suffix { position: absolute; right: 16px; color: #9ca3af; font-weight: 500; font-size: 0.9rem; pointer-events: none; }

        /* Status Box */
        .status-card { background: #f9fafb; border-radius: 16px; padding: 16px; border: 1px solid #f3f4f6; }
        .limit-label { font-size: 0.8rem; color: #6b7280; font-weight: 500; }
        .limit-value { font-size: 1.5rem; font-weight: 800; color: var(--primary); letter-spacing: -0.03em; }
        #statusText { margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb; font-size: 0.95rem; }

        /* Spinner */
        #loading { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 15px 30px; border-radius: 50px; box-shadow: var(--shadow); z-index: 2000; font-weight: 600; color: var(--primary); gap: 10px; align-items: center; }
        .spinner { width: 18px; height: 18px; border: 2px solid #e5e7eb; border-top: 2px solid var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- M√ìVIL (BOTTOM SHEET) --- */
        @media (max-width: 768px) {
            .ui-container {
                top: auto; bottom: 0; left: 0; width: 100%;
                /* Por defecto abierto, pero listo para moverse */
            }

            .card {
                border-radius: 24px 24px 0 0; /* Solo bordes de arriba */
                padding-bottom: 40px; /* Espacio extra para iPhone bar */
                gap: 12px;
            }

            .drag-handle { 
                display: block; /* Mostramos la barrita solo en m√≥vil */
                background: #d1d5db;
            }

            /* CLASE M√ÅGICA: Cuando est√° colapsado */
            .ui-container.collapsed {
                /* Bajamos todo excepto la cabecera (aprox 80px visibles) */
                transform: translateY(calc(100% - 85px)); 
            }
            
            /* Indicador visual de que la barrita cambi√≥ de estado */
            .ui-container.collapsed .drag-handle {
                background: var(--accent); /* Se pone azul para invitar a subir */
                width: 50px;
            }
        }
    </style>
</head>
<body>

    <div id="loading"><div class="spinner"></div>Cargando...</div>

    <div class="ui-container" id="panelLateral">
        <div class="card">
            
            <div class="card-header" onclick="togglePanel()">
                <div class="drag-handle"></div> <h2 id="mainTitle" data-provincia="">üìç Espa√±a</h2>
                <span class="subtitle">Toca aqu√≠ para ver/ocultar filtros</span>
            </div>

            <div class="input-group">
                <label>Sueldo Neto</label>
                <div class="input-wrapper">
                    <input type="number" id="salary" value="1500" placeholder="0">
                    <span class="suffix">‚Ç¨</span>
                </div>
            </div>

            <div class="input-group">
                <label>Metros¬≤</label>
                <div class="input-wrapper">
                    <input type="number" id="size" value="60" placeholder="0">
                    <span class="suffix">m¬≤</span>
                </div>
            </div>

            <div class="status-card">
                <div style="display:flex; justify-content:space-between; align-items:baseline;">
                    <div class="limit-label">Tu tope (35%)</div>
                    <div id="limitDisplay" class="limit-value">525‚Ç¨</div>
                </div>
                <div id="statusText"><span style="color:#9ca3af">Explora el mapa...</span></div>
            </div>

        </div>
    </div>

    <div id="map"></div>

    <script src="provincias.js"></script>

    <script>
        // --- FUNCI√ìN ACORDE√ìN (MINIMIZAR/EXPANDIR) ---
        function togglePanel() {
            // Solo actuar en m√≥vil (ancho menor a 768px)
            if (window.innerWidth < 768) {
                const panel = document.getElementById('panelLateral');
                panel.classList.toggle('collapsed');
            }
        }

        // --- MAPA SETUP ---
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([40.416775, -3.703790], 6);
        L.control.zoom({ position: 'topright' }).addTo(map); // Zoom arriba para no molestar al panel
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '¬©CartoDB' }).addTo(map);

        let geoLayer, muniLayer, topoData, currentLevel = 'provincias', provinciaActivaLayer;

        // DICCIONARIO INE (Resumido para el ejemplo, usa el completo)
        const codigosINE = {
            "Araba/√Ålava": "01", "√Ålava": "01", "Albacete": "02", "Alicante/Alacant": "03", "Alicante": "03",
            "Almer√≠a": "04", "√Åvila": "05", "Badajoz": "06", "Illes Balears": "07", "Baleares": "07",
            "Barcelona": "08", "Burgos": "09", "C√°ceres": "10", "C√°diz": "11",
            "Castell√≥n/Castell√≥": "12", "Castell√≥n": "12", "Ciudad Real": "13", "C√≥rdoba": "14",
            "A Coru√±a": "15", "La Coru√±a": "15", "Cuenca": "16", "Girona": "17", "Gerona": "17",
            "Granada": "18", "Guadalajara": "19", "Gipuzkoa": "20", "Guip√∫zcoa": "20",
            "Huelva": "21", "Huesca": "22", "Ja√©n": "23", "Le√≥n": "24", "Lleida": "25", "L√©rida": "25",
            "La Rioja": "26", "Lugo": "27", "Madrid": "28", "M√°laga": "29", "Murcia": "30",
            "Navarra": "31", "Ourense": "32", "Orense": "32", "Asturias": "33", "Palencia": "34",
            "Las Palmas": "35", "Pontevedra": "36", "Salamanca": "37", "Santa Cruz de Tenerife": "38",
            "Cantabria": "39", "Segovia": "40", "Sevilla": "41", "Soria": "42", "Tarragona": "43",
            "Teruel": "44", "Toledo": "45", "Valencia/Val√©ncia": "46", "Valencia": "46",
            "Valladolid": "47", "Bizkaia": "48", "Vizcaya": "48", "Zamora": "49", "Zaragoza": "50",
            "Ceuta": "51", "Melilla": "52"
        };

        // PRECIOS (Pega tu lista completa aqu√≠)
        const preciosProvincias = {
  // --- ANDALUC√çA ---
  "Almer√≠a": 8.4,
  "C√°diz": 10.1,
  "C√≥rdoba": 8.5,
  "Granada": 9.8,
  "Huelva": 8.7,
  "Ja√©n": 6.4,
  "M√°laga": 16.6,
  "Sevilla": 11.7,
  
  // --- ARAG√ìN ---
  "Huesca": 9.4,
  "Teruel": 7.4,
  "Zaragoza": 10.6,
  
  // --- NORTE ---
  "Asturias": 10.0,
  "Cantabria": 10.8,
  "La Rioja": 8.9,
  "Navarra": 10.7,
  "Bizkaia": 14.6,     // En Idealista sale como Vizcaya, ajusta seg√∫n tu GeoJSON
  "Gipuzkoa": 16.3,    // En Idealista sale como Guip√∫zcoa
  "Araba": 12.3,       // En Idealista sale como √Ålava
  "Vizcaya": 14.6,     // Te pongo ambos por si acaso
  "Guip√∫zcoa": 16.3,
  "√Ålava": 12.3,

  // --- CASTILLA Y LE√ìN ---
  "√Åvila": 7.7,
  "Burgos": 9.0,
  "Le√≥n": 7.8,
  "Palencia": 7.8,
  "Salamanca": 9.5,
  "Segovia": 11.8,
  "Soria": 8.1,
  "Valladolid": 9.1,
  "Zamora": 7.2,

  // --- CASTILLA-LA MANCHA ---
  "Albacete": 8.0,
  "Ciudad Real": 7.0,
  "Cuenca": 7.6,
  "Guadalajara": 9.8,
  "Toledo": 8.5,

  // --- CATALU√ëA ---
  "Barcelona": 20.6,
  "Girona": 12.7,
  "Lleida": 11.0,
  "Tarragona": 9.9,

  // --- COMUNIDAD VALENCIANA ---
  "Alicante": 11.9,    // Idealista: Alicante/Alacant
  "Castell√≥n": 8.6,    // Idealista: Castell√≥n/Castell√≥
  "Valencia": 13.5,    // Idealista: Valencia/Val√©ncia

  // --- EXTREMADURA ---
  "Badajoz": 7.2,
  "C√°ceres": 7.3,

  // --- GALICIA ---
  "A Coru√±a": 9.3,
  "Lugo": 7.4,
  "Ourense": 7.4,
  "Pontevedra": 9.9,

  // --- ISLAS ---
  "Baleares": 19.1,    // A veces es "Illes Balears" en GeoJSON
  "Illes Balears": 19.1,
  "Las Palmas": 15.4,
  "Santa Cruz de Tenerife": 14.8,

  // --- OTROS ---
  "Madrid": 21.0,
  "Murcia": 8.8,
  "Ceuta": 13.9,
  "Melilla": 10.3
};

        // L√ìGICA DE NEGOCIO
        function getRentLimit() {
            const sal = parseFloat(document.getElementById('salary').value) || 0;
            const limit = sal * 0.35;
            document.getElementById('limitDisplay').innerText = limit.toFixed(0) + '‚Ç¨';
            return limit;
        }

        function getColor(p, l) {
            if(!p) return '#cbd5e1';
            const s = parseFloat(document.getElementById('size').value) || 60;
            return (p * s) <= l ? '#10b981' : '#ef4444';
        }

        function style(f) {
            let p;
            if(f.properties.Texto) p = preciosProvincias[f.properties.Texto];
            else {
                const base = preciosProvincias[document.getElementById('mainTitle').dataset.provincia] || 8;
                p = base + ((parseInt(f.id)%20 - 10)/10);
            }
            return { fillColor: getColor(p, getRentLimit()), weight: 1, opacity: 1, color: 'white', fillOpacity: 0.7 };
        }

        function highlightFeature(e) {
            const props = e.target.feature.properties;
            const name = props.Texto || props.name || "Zona";
            
            // Decidir precio a mostrar
            let pShow;
            if(currentLevel === 'provincias') pShow = preciosProvincias[name];
            else pShow = preciosProvincias[document.getElementById('mainTitle').dataset.provincia];

            const html = `<div style="font-weight:600">${name}</div>
                          <div style="font-size:1.2rem; font-weight:800; color:${getColor(pShow, getRentLimit())}">
                          ${pShow ? pShow + ' ‚Ç¨/m¬≤' : 'S/D'}</div>`;
            
            document.getElementById('statusText').innerHTML = html;
            e.target.setStyle({ weight: 3, color: '#333', fillOpacity: 0.9 });
        }

        function resetHighlight(e) {
            if(currentLevel === 'provincias') geoLayer.resetStyle(e.target);
            else muniLayer.resetStyle(e.target);
        }

        async function clickFeature(e) {
            const layer = e.target;
            const nombre = layer.feature.properties.Texto;
            const codigo = codigosINE[nombre];

            if(codigo) {
                // 1. MINIMIZAR PANEL AUTOM√ÅTICAMENTE EN M√ìVIL AL CLICAR
                if(window.innerWidth < 768) {
                    document.getElementById('panelLateral').classList.add('collapsed');
                }

                document.getElementById('loading').style.display = 'flex';
                
                if(muniLayer) map.removeLayer(muniLayer);
                if(provinciaActivaLayer) provinciaActivaLayer.setStyle({ opacity: 1, fillOpacity: 0.7, interactive: true });

                provinciaActivaLayer = layer;
                currentLevel = 'municipios';
                
                const t = document.getElementById('mainTitle');
                t.innerText = `üìç ${nombre}`;
                t.dataset.provincia = nombre;
                
                layer.setStyle({ opacity: 0, fillOpacity: 0, interactive: false });

                if(!topoData) {
                    try {
                        const r = await fetch('https://unpkg.com/es-atlas/es/municipalities.json');
                        topoData = await r.json();
                    } catch(e) { alert("Error red"); return; }
                }

                const geojson = topojson.feature(topoData, topoData.objects.municipalities);
                const feats = { type: "FeatureCollection", features: geojson.features.filter(f => f.id && String(f.id).startsWith(codigo)) };

                muniLayer = L.geoJson(feats, {
                    style: style,
                    onEachFeature: (f, l) => l.on({ mouseover: highlightFeature, mouseout: resetHighlight })
                }).addTo(map);

                map.fitBounds(muniLayer.getBounds(), { padding: [20, 20] });
                document.getElementById('loading').style.display = 'none';
            }
        }

        // INIT
        geoLayer = L.geoJson(provinciasGeoJSON, {
            style: style,
            onEachFeature: (f, l) => l.on({ mouseover: highlightFeature, mouseout: resetHighlight, click: clickFeature })
        }).addTo(map);

        ['salary', 'size'].forEach(id => document.getElementById(id).addEventListener('input', () => {
            getRentLimit();
            geoLayer.setStyle(style);
            if(muniLayer) muniLayer.setStyle(style);
        }));
        
        getRentLimit();
    </script>
</body>
</html>
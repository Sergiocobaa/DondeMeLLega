<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EG1D52M1GF"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-EG1D52M1GF');
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5195189445727505"
     crossorigin="anonymous"></script>
    
    <title>Mapa de Alquileres Espa√±a | ¬øD√≥nde te llega el sueldo? - PreciosAlquiler.es</title>
    <meta name="description" content="Descubre d√≥nde puedes vivir con tu sueldo. Mapa interactivo de precios de alquiler en Espa√±a 2025. Consulta la viabilidad por provincias y municipios seg√∫n tus ingresos.">
    <meta name="keywords" content="precio alquiler espa√±a, mapa alquiler, idealista mapa, donde vivir con mi sueldo, precio m2 vivienda, alquiler barato">
    <meta name="author" content="PreciosAlquiler.es">
    <meta name="robots" content="index, follow">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.preciosalquiler.es/">
    <meta property="og:title" content="¬øD√≥nde te llega el sueldo para vivir? üè†">
    <meta property="og:description" content="He creado un mapa que cruza tu sueldo con los precios reales del alquiler en Espa√±a. Mira qu√© zonas est√°n en verde para ti.">
    <meta property="og:image" content="https://www.preciosalquiler.es/assets/og-image.png"> <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <link rel="icon" type="image/png" href="favicon.png">

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js"></script>

    <style>
        /* --- ESTILOS VISUALES --- */
        :root { --primary: #111827; --accent: #2563eb; --surface: rgba(255, 255, 255, 0.95); --shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.15); }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; overflow: hidden; background: #e5e7eb; }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 0; }

        /* UI Flotante */
        .ui-container { position: absolute; top: 24px; left: 24px; width: 360px; z-index: 1000; transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1); }
        .card { background: var(--surface); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); padding: 24px; border-radius: 24px; box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.6); display: flex; flex-direction: column; gap: 16px; }
        
        .card-header { cursor: pointer; }
        .drag-handle { width: 40px; height: 5px; background: #e5e7eb; border-radius: 10px; margin: -10px auto 15px auto; display: none; }
        
        h2 { margin: 0; font-size: 1.25rem; font-weight: 800; color: var(--primary); letter-spacing: -0.03em; }
        .subtitle { font-size: 0.875rem; color: #6b7280; display: block; margin-top: 4px;}

        /* Inputs */
        .input-group label { display: block; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #9ca3af; margin-bottom: 6px; letter-spacing: 0.05em; }
        .input-wrapper { position: relative; display: flex; align-items: center; }
        input[type="number"] { width: 100%; padding: 12px 16px; border: 2px solid #f3f4f6; border-radius: 12px; font-size: 1rem; font-weight: 600; color: var(--primary); outline: none; transition: border 0.2s; font-family: 'Inter', sans-serif; }
        input[type="number"]:focus { border-color: var(--accent); }
        .suffix { position: absolute; right: 16px; color: #9ca3af; font-weight: 500; font-size: 0.9rem; pointer-events: none; }

        /* SLIDER (NUEVO ESTILO) */
        input[type="range"] {
            -webkit-appearance: none; width: 100%; height: 6px; background: #e5e7eb; border-radius: 5px; outline: none; margin-top: 5px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--accent); cursor: pointer; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Status Box */
        .status-card { background: #f9fafb; border-radius: 16px; padding: 16px; border: 1px solid #f3f4f6; }
        .limit-value { font-size: 1.5rem; font-weight: 800; color: var(--primary); letter-spacing: -0.03em; }
        #statusText { margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb; font-size: 0.95rem; }

        /* Footer */
        .legal-footer { margin-top: 10px; text-align: center; font-size: 0.75rem; color: #9ca3af; border-top: 1px solid #f3f4f6; padding-top: 15px; }
        .legal-footer a { color: #9ca3af; text-decoration: none; margin: 0 5px; }
        
        /* Spinner */
        #loading { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 15px 30px; border-radius: 50px; box-shadow: var(--shadow); z-index: 2000; font-weight: 600; color: var(--primary); gap: 10px; align-items: center; }
        .spinner { width: 18px; height: 18px; border: 2px solid #e5e7eb; border-top: 2px solid var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Bot√≥n Info SEO */
        .info-btn { position: absolute; bottom: 20px; right: 20px; background: white; width: 40px; height: 40px; border-radius: 50%; box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--accent); cursor: pointer; z-index: 998; }

        /* M√≥vil */
        @media (max-width: 768px) {
            .ui-container { top: auto; bottom: 0; left: 0; width: 100%; }
            .card { border-radius: 24px 24px 0 0; padding-bottom: 40px; gap: 12px; }
            .drag-handle { display: block; background: #d1d5db; }
            .ui-container.collapsed { transform: translateY(calc(100% - 85px)); }
            .ui-container.collapsed .drag-handle { background: var(--accent); width: 50px; }
            .info-btn { bottom: 100px; right: 10px; } /* Mover bot√≥n info arriba en m√≥vil */
        }

        /* --- ESTILOS DEL BUSCADOR --- */
        #searchInput {
            width: 100%;
            padding: 12px 12px 12px 40px; /* Hueco para la lupa */
            border: 2px solid #f3f4f6;
            border-radius: 12px;
            font-size: 0.95rem;
            font-family: 'Inter', sans-serif;
            background: #f9fafb;
            transition: all 0.2s;
            box-sizing: border-box; /* Importante para que no se salga */
        }

        #searchInput:focus {
            border-color: var(--accent);
            background: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        .results-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-top: 8px;
            padding: 0;
            list-style: none;
            max-height: 250px;
            overflow-y: auto;
            z-index: 2000;
            display: none; /* Oculto por defecto */
            border: 1px solid #e5e7eb;
        }

        .results-list li {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
        }

        .results-list li:last-child { border-bottom: none; }
        .results-list li:hover { background: #f0f9ff; color: var(--accent); }
        .results-list li small { color: #9ca3af; font-size: 0.75rem; }
    </style>
</head>
<body>

    <div id="loading"><div class="spinner"></div>Cargando...</div>

    <div class="info-btn" onclick="document.getElementById('seo-modal').style.display='block'">?</div>

    <div id="seo-modal" style="display:flex; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:2000; backdrop-filter:blur(5px); align-items:center; justify-content:center;">
        <div style="background:white; max-width:500px; width:90%; padding:30px; border-radius:24px; position:relative; max-height:80vh; overflow-y:auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
            
            <button onclick="cerrarModal()" style="position:absolute; top:15px; right:15px; border:none; background:#f3f4f6; width:30px; height:30px; border-radius:50%; font-size:1.2rem; cursor:pointer; color:#374151;">&times;</button>
            
            <h2 style="margin-top:0; color:#111827;">üè† ¬øD√≥nde te llega el sueldo?</h2>
            
            <p style="color:#4b5563; line-height:1.6;">Esta herramienta cruza los datos oficiales del alquiler en Espa√±a con tu salario neto.</p>
            
            <div style="background:#eff6ff; padding:15px; border-radius:12px; margin:15px 0;">
                <h3 style="margin:0 0 10px 0; color:#1e40af; font-size:1rem;">‚ÑπÔ∏è C√≥mo funciona</h3>
                <ul style="margin:0; padding-left:20px; color:#1e3a8a; font-size:0.9rem;">
                    <li>Introduce tu <strong>Sueldo Neto</strong>.</li>
                    <li>El mapa se colorear√° seg√∫n la <strong>Regla del 35%</strong>.</li>
                    <li>Verde = Puedes pagarlo. Rojo = Riesgo.</li>
                </ul>
            </div>

            <p style="font-size:0.8rem; color:#9ca3af; margin-top:20px;">
                Datos basados en el Sistema Estatal de Referencia (MIVAU) y precios de mercado actuales.
            </p>

            <button onclick="cerrarModal()" style="width:100%; background:#2563eb; color:white; border:none; padding:12px; border-radius:12px; font-weight:600; font-size:1rem; cursor:pointer; margin-top:10px;">
                Ver Mapa
            </button>
        </div>
    </div>

    <div class="ui-container" id="panelLateral">
            <div class="card">
                        <div class="search-container" style="position: relative; margin-bottom: 10px;">
                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5;">üîç</span>
                
                <input type="text" id="searchInput" placeholder="Buscar municipio..." autocomplete="off">
                
                <ul id="searchResults" class="results-list"></ul>
            </div>
            <div class="card-header" onclick="togglePanel()">
                <div class="drag-handle"></div>
                <h2 id="mainTitle" data-provincia="">üìç Espa√±a</h2>
                <span class="subtitle">Toca para ver/ocultar filtros</span>
            </div>

            <div class="input-group">
                <label>Sueldo Neto Mensual</label>
                <div class="input-wrapper">
                    <input type="number" id="salary" value="1500" placeholder="0">
                    <span class="suffix">‚Ç¨</span>
                </div>
            </div>

            <div class="input-group">
                <label>Tama√±o piso deseado</label>
                <div class="input-wrapper">
                    <input type="number" id="size" value="60" placeholder="0">
                    <span class="suffix">m¬≤</span>
                </div>
            </div>

            <div class="input-group">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <label style="margin:0;">Esfuerzo M√°ximo</label>
                    <span id="ratioLabel" style="font-weight:700; color:var(--accent); font-size:0.9rem;">35%</span>
                </div>
                <input type="range" id="ratio" min="10" max="60" value="35" step="1">
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#9ca3af; margin-top:2px;">
                    <span>Conservador</span>
                    <span>Arriesgado</span>
                </div>
            </div>

            <div class="status-card">
                <div style="display:flex; justify-content:space-between; align-items:baseline;">
                    <div style="font-size:0.8rem; color:#6b7280; font-weight:500;">Tu alquiler m√°x.</div>
                    <div id="limitDisplay" class="limit-value">525‚Ç¨</div>
                </div>
                <div id="statusText"><span style="color:#9ca3af">Explora el mapa...</span></div>
            </div>

            <div style="margin-top: 15px; min-height: 250px; background: #f9fafb; border-radius: 12px; display:flex; align-items:center; justify-content:center;">
                <span style="font-size:10px; color:#ccc;">Espacio Publicidad</span>
                </div>

            <div class="legal-footer">
                <a href="privacidad.html" target="_blank">Privacidad</a> ‚Ä¢ <a href="cookies.html" target="_blank">Cookies</a>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="provincias.js"></script>
    <script src="datos_mivau.js"></script>
    <script>
        function cerrarModal() {
            document.getElementById('seo-modal').style.display = 'none';
        }
        // --- LOGICA UI (Panel y Slider) ---
        function togglePanel() {
            if (window.innerWidth < 768) {
                document.getElementById('panelLateral').classList.toggle('collapsed');
            }
        }

        // --- MAPA SETUP ---
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([40.416775, -3.703790], 6);
        L.control.zoom({ position: 'topright' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '¬©CartoDB' }).addTo(map);

        let geoLayer, muniLayer, topoData, currentLevel = 'provincias', provinciaActivaLayer;

        // DICCIONARIO INE (Para saber qu√© provincia se clica)
        const codigosINE = { "Araba/√Ålava": "01", "√Ålava": "01", "Albacete": "02", "Alicante/Alacant": "03", "Alicante": "03", "Almer√≠a": "04", "√Åvila": "05", "Badajoz": "06", "Illes Balears": "07", "Baleares": "07", "Barcelona": "08", "Burgos": "09", "C√°ceres": "10", "C√°diz": "11", "Castell√≥n/Castell√≥": "12", "Castell√≥n": "12", "Ciudad Real": "13", "C√≥rdoba": "14", "A Coru√±a": "15", "La Coru√±a": "15", "Cuenca": "16", "Girona": "17", "Gerona": "17", "Granada": "18", "Guadalajara": "19", "Gipuzkoa": "20", "Guip√∫zcoa": "20", "Huelva": "21", "Huesca": "22", "Ja√©n": "23", "Le√≥n": "24", "Lleida": "25", "L√©rida": "25", "La Rioja": "26", "Lugo": "27", "Madrid": "28", "M√°laga": "29", "Murcia": "30", "Navarra": "31", "Ourense": "32", "Orense": "32", "Asturias": "33", "Palencia": "34", "Las Palmas": "35", "Pontevedra": "36", "Salamanca": "37", "Santa Cruz de Tenerife": "38", "Cantabria": "39", "Segovia": "40", "Sevilla": "41", "Soria": "42", "Tarragona": "43", "Teruel": "44", "Toledo": "45", "Valencia/Val√©ncia": "46", "Valencia": "46", "Valladolid": "47", "Bizkaia": "48", "Vizcaya": "48", "Zamora": "49", "Zaragoza": "50", "Ceuta": "51", "Melilla": "52" };

        // PRECIOS BASE PROVINCIAS (Fallback si falla MIVAU)
        // Actualiza esto con los datos de Idealista de este mes para las provincias
        const preciosProvincias = { "Barcelona": 20.6, "Madrid": 21.0, "Valencia": 13.5, "M√°laga": 16.6, "Sevilla": 11.7, "Zaragoza": 10.6, "Bizkaia": 14.6, "Baleares": 19.1, "Gipuzkoa": 16.3, "Las Palmas": 15.4, "Santa Cruz de Tenerife": 14.8, "Murcia": 8.5, "Alicante": 11.0, "Asturias": 9.2 };

        // --- C√ÅLCULOS ---
        function getRentLimit() {
            const sal = parseFloat(document.getElementById('salary').value) || 0;
            const ratioPercent = parseInt(document.getElementById('ratio').value) || 35;
            
            document.getElementById('ratioLabel').innerText = ratioPercent + '%';
            
            const limit = sal * (ratioPercent / 100);
            document.getElementById('limitDisplay').innerText = limit.toFixed(0) + '‚Ç¨';
            return limit;
        }

        function getColor(p, l) {
            if(!p) return '#cbd5e1'; // Gris si no hay datos
            const s = parseFloat(document.getElementById('size').value) || 60;
            return (p * s) <= l ? '#10b981' : '#ef4444'; // Verde vs Rojo
        }

        // --- FUNCI√ìN CLAVE: OBTENER PRECIO ---
        function getPrecioZona(feature) {
            // 1. NIVEL MUNICIPIO (Buscamos por ID en MIVAU)
            if (feature.id && typeof preciosMIVAU !== 'undefined') {
                // Convertimos a string y aseguramos 5 d√≠gitos (por si acaso el mapa trae numero)
                let codigo = String(feature.id);
                if(codigo.length === 4) codigo = "0" + codigo; 

                const precioOficial = preciosMIVAU[codigo];
                if (precioOficial) return precioOficial;
            }

            // 2. NIVEL PROVINCIA O FALLBACK (Usamos nombre)
            const nombre = feature.properties.Texto || feature.properties.name;
            if (preciosProvincias[nombre]) return preciosProvincias[nombre];
            
            // 3. MEDIA GENERAL DE LA PROVINCIA ACTIVA
            const provActual = document.getElementById('mainTitle').dataset.provincia;
            return preciosProvincias[provActual] || 8.0;
        }

        function style(f) {
            const limit = getRentLimit();
            const precio = getPrecioZona(f);
            return { fillColor: getColor(precio, limit), weight: 1, opacity: 1, color: 'white', fillOpacity: 0.7 };
        }

        function highlightFeature(e) {
            const layer = e.target;
            const props = layer.feature.properties;
            const name = props.Texto || props.name || "Zona";
            const precio = getPrecioZona(layer.feature);
            
            // Detectar fuente del dato para la etiqueta
            let esOficial = false;
            if(layer.feature.id && typeof preciosMIVAU !== 'undefined') {
                let codigo = String(layer.feature.id);
                if(codigo.length === 4) codigo = "0" + codigo;
                if(preciosMIVAU[codigo]) esOficial = true;
            }

            const etiquetaFuente = esOficial 
                ? '<span style="font-size:0.6rem; background:#dcfce7; color:#166534; padding:2px 6px; border-radius:4px; margin-left:8px;">Oficial MIVAU</span>' 
                : '<span style="font-size:0.6rem; background:#f3f4f6; color:#6b7280; padding:2px 6px; border-radius:4px; margin-left:8px;">Estimado Prov.</span>';

            const html = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-weight:600; font-size:1.1rem; color:var(--primary)">${name}</span>
                </div>
                <div style="margin-top:4px; display:flex; align-items:baseline;">
                    <span style="font-size:1.4rem; font-weight:800; color:${getColor(precio, getRentLimit())}">
                        ${precio ? precio.toFixed(1) + '<small style="font-size:0.9rem; color:#6b7280"> ‚Ç¨/m¬≤</small>' : 'S/D'}
                    </span>
                    ${etiquetaFuente}
                </div>`;
            
            document.getElementById('statusText').innerHTML = html;
            layer.setStyle({ weight: 3, color: '#333', fillOpacity: 0.9 });
            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) layer.bringToFront();
        }

        function resetHighlight(e) {
            const layer = e.target;
            if(currentLevel === 'provincias') geoLayer.resetStyle(layer);
            else muniLayer.resetStyle(layer);
            document.getElementById('statusText').innerHTML = '<span style="color:#9ca3af">Explora el mapa...</span>';
        }

        async function clickFeature(e) {
            const layer = e.target;
            const nombre = layer.feature.properties.Texto;
            const codigo = codigosINE[nombre];

            if(codigo) {
                if(window.innerWidth < 768) document.getElementById('panelLateral').classList.add('collapsed');
                document.getElementById('loading').style.display = 'flex';
                
                if(muniLayer) map.removeLayer(muniLayer);
                if(provinciaActivaLayer) provinciaActivaLayer.setStyle({ opacity: 1, fillOpacity: 0.7, interactive: true });

                provinciaActivaLayer = layer;
                currentLevel = 'municipios';
                
                const t = document.getElementById('mainTitle');
                t.innerText = `üìç ${nombre}`;
                t.dataset.provincia = nombre;
                
                layer.setStyle({ opacity: 0, fillOpacity: 0, interactive: false });

                if(!topoData) {
                    try {
                        const r = await fetch('https://unpkg.com/es-atlas/es/municipalities.json');
                        topoData = await r.json();
                    } catch(e) { alert("Error cargando mapa"); return; }
                }

                const geojson = topojson.feature(topoData, topoData.objects.municipalities);
                // FILTRO SEGURO (El arreglo que hicimos antes)
                const feats = { type: "FeatureCollection", features: geojson.features.filter(f => f.id && String(f.id).startsWith(codigo)) };

                muniLayer = L.geoJson(feats, {
                    style: style,
                    onEachFeature: (f, l) => l.on({ mouseover: highlightFeature, mouseout: resetHighlight })
                }).addTo(map);

                map.fitBounds(muniLayer.getBounds(), { padding: [20, 20] });
                document.getElementById('loading').style.display = 'none';
            }
        }

        // CARGA INICIAL
        geoLayer = L.geoJson(provinciasGeoJSON, {
            style: style,
            onEachFeature: (f, l) => l.on({ mouseover: highlightFeature, mouseout: resetHighlight, click: clickFeature })
        }).addTo(map);

        ['salary', 'size', 'ratio'].forEach(id => document.getElementById(id).addEventListener('input', () => {
            getRentLimit();
            geoLayer.setStyle(style);
            if(muniLayer) muniLayer.setStyle(style);
        }));
        
        getRentLimit();

        // --- L√ìGICA DEL BUSCADOR ---
        let searchIndex = []; // Aqu√≠ guardaremos los 8.000 pueblos

        // 1. Cargar la base de datos de nombres (solo una vez)
        async function initSearch() {
            try {
                // Reusamos el archivo que ya usa el mapa
                if(!topoData) {
                    const r = await fetch('https://unpkg.com/es-atlas/es/municipalities.json');
                    topoData = await r.json();
                }
                
                // Convertimos TopoJSON a lista simple para buscar r√°pido
                const geojson = topojson.feature(topoData, topoData.objects.municipalities);
                searchIndex = geojson.features.map(f => ({
                    name: f.properties.name,
                    id: f.id, // C√≥digo INE (ej: 28079)
                    // Guardamos coordenadas del centro para hacer zoom directo
                    // (Leaflet/TopoJSON no da centro directo f√°cil, usaremos bounds luego)
                    feature: f 
                }));
                
                console.log("Buscador listo: " + searchIndex.length + " municipios indexados.");
            } catch(e) { console.error("Error iniciando buscador", e); }
        }

        // Llamamos a esto al arrancar la web
        initSearch();

        // 2. Escuchar lo que escribe el usuario
        const input = document.getElementById('searchInput');
        const resultsList = document.getElementById('searchResults');

        input.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            
            if(term.length < 3) { // No buscar si escribe poco
                resultsList.style.display = 'none';
                return;
            }

            // Filtramos (M√°ximo 10 resultados para no saturar)
            const matches = searchIndex.filter(item => {
                const normName = item.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                return normName.includes(term);
            }).slice(0, 8);

            renderResults(matches);
        });
        function getNombreProvincia(codigoINE) {
            const prefijo = String(codigoINE).padStart(5, '0').substring(0, 2);
            // Buscamos en tu diccionario codigosINE qu√© provincia tiene ese n√∫mero
            // Preferimos nombres cortos (ej: "Valencia" mejor que "Valencia/Val√©ncia")
            return Object.keys(codigosINE).find(key => codigosINE[key] === prefijo && !key.includes('/')) 
                || Object.keys(codigosINE).find(key => codigosINE[key] === prefijo) 
                || "Espa√±a";
        }
        // 3. Mostrar la lista
        function renderResults(matches) {
            resultsList.innerHTML = '';
            
            if(matches.length === 0) {
                resultsList.style.display = 'none';
                return;
            }

            matches.forEach(m => {
                const li = document.createElement('li');
                
                // TRUCO: Sacamos el nombre de la provincia usando el c√≥digo INE
                const nombreProv = getNombreProvincia(m.id);
                
                // HTML m√°s limpio: Nombre Pueblo (Provincia)
                li.innerHTML = `
                    <span style="font-weight:500">${m.name}</span> 
                    <small style="color:#2563eb; background:#eff6ff; padding:2px 8px; border-radius:10px;">${nombreProv}</small>
                `;
                
                li.onclick = () => selectMunicipio(m);
                resultsList.appendChild(li);
            });
            
            resultsList.style.display = 'block';
        }
        // 4. Qu√© pasa al hacer clic en un pueblo
        function selectMunicipio(item) {
            // A. Limpiamos buscador
            input.value = item.name;
            resultsList.style.display = 'none';

            // B. L√≥gica de Mapa (Reusamos tu l√≥gica existente)
            // 1. Detectar provincia (primeros 2 d√≠gitos del ID)
            const codProv = String(item.id).substring(0, 2); 
            // 2. Cargar esa capa de municipios si no est√° cargada
            
            document.getElementById('loading').style.display = 'flex';

            // Borramos capa anterior
            if(muniLayer) map.removeLayer(muniLayer);
            
            // Filtramos solo los municipios de esa provincia (para no cargar Espa√±a entera)
            const geojson = topojson.feature(topoData, topoData.objects.municipalities);
            const featsProvincia = { 
                type: "FeatureCollection", 
                features: geojson.features.filter(f => f.id && String(f.id).startsWith(codProv)) 
            };

            // Pintamos la provincia entera
            muniLayer = L.geoJson(featsProvincia, {
                style: style,
                onEachFeature: (f, l) => l.on({ mouseover: highlightFeature, mouseout: resetHighlight })
            }).addTo(map);

            // C. ZOOM AL MUNICIPIO ESPEC√çFICO
            // Buscamos el layer espec√≠fico del pueblo que hemos clicado
            const layerPueblo = muniLayer.getLayers().find(l => l.feature.id === item.id);
            
            if(layerPueblo) {
                // Animaci√≥n de viaje
                map.flyToBounds(layerPueblo.getBounds(), { padding: [100, 100], duration: 1.5 });
                
                // Simulamos que el usuario pas√≥ el rat√≥n para ver el precio
                highlightFeature({ target: layerPueblo });
                
                // Actualizamos t√≠tulo del panel
                const t = document.getElementById('mainTitle');
                t.innerText = `üìç ${item.name}`;
                
                // En m√≥vil, colapsamos el panel para ver el mapa
                if(window.innerWidth < 768) {
                    document.getElementById('panelLateral').classList.add('collapsed');
                }
            }

            document.getElementById('loading').style.display = 'none';
            currentLevel = 'municipios';
        }

        // Cerrar lista si clicas fuera
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                resultsList.style.display = 'none';
            }
        });
    </script>
</body>
</html>